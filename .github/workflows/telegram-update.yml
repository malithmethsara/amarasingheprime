name: Telegram Rate Update

on:
  workflow_dispatch:
    inputs:
      rate:
        description: 'Rate or Date,Rate'
        required: true

permissions:
  contents: write

jobs:
  update-sort-clean:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Smart Update & Sort
        run: |
          # --- STEP 1: PARSE INPUT ---
          RAW_INPUT="${{ inputs.rate }}"
          
          # Check if input has a comma (Format: YYYY-MM-DD,Rate)
          if [[ "$RAW_INPUT" == *","* ]]; then
            THE_DATE=$(echo "$RAW_INPUT" | cut -d',' -f1 | xargs)
            THE_RATE=$(echo "$RAW_INPUT" | cut -d',' -f2 | xargs)
          else
            # No date provided? Use Today.
            THE_DATE=$(date +'%Y-%m-%d')
            THE_RATE=$(echo "$RAW_INPUT" | xargs)
          fi
          
          NEW_LINE="$THE_DATE,$THE_RATE"
          echo "Processing: $NEW_LINE"

          # --- STEP 2: APPEND NEW DATA ---
          # Add the new line to the bottom of the file
          echo "$NEW_LINE" >> "CBSL rates.txt"

          # --- STEP 3: SORT & REMOVE DUPLICATES ---
          # Logic: Read file -> Keep only the LAST rate seen for each date -> Sort by date
          awk -F, '{rates[$1]=$2} END {for (d in rates) print d","rates[d]}' "CBSL rates.txt" | sort > temp_sorted.txt
          
          # specific check to ensure we didn't wipe the file
          if [ -s temp_sorted.txt ]; then
             mv temp_sorted.txt "CBSL rates.txt"
             echo "‚úÖ File successfully sorted and cleaned."
          else
             echo "‚ùå Error: Something went wrong, keeping old file."
             exit 1
          fi

          # --- STEP 4: SAVE TO GITHUB ---
          git config --global user.name "Telegram Bot"
          git config --global user.email "actions@github.com"
          git add "CBSL rates.txt"
          
          # Only commit if actual changes happened
          git diff --quiet && git diff --staged --quiet || (git commit -m "üìà Update: $NEW_LINE" && git push)
