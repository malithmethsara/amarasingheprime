name: Telegram Rate Update

on:
  workflow_dispatch:
    inputs:
      rate:
        description: 'Raw input from Telegram'
        required: true

permissions:
  contents: write

jobs:
  append-rate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Smart Update
        run: |
          # 1. Get the raw input from Telegram
          RAW_INPUT="${{ inputs.rate }}"
          
          # 2. Check if it contains a comma (Format: YYYY-MM-DD,Rate)
          if [[ "$RAW_INPUT" == *","* ]]; then
            # Split the text at the comma
            THE_DATE=$(echo "$RAW_INPUT" | cut -d',' -f1)
            THE_RATE=$(echo "$RAW_INPUT" | cut -d',' -f2)
            echo "ðŸ“… Custom Date Detected: $THE_DATE"
          else
            # No comma? Use today's date automatically
            THE_DATE=$(date +'%Y-%m-%d')
            THE_RATE="$RAW_INPUT"
            echo "ðŸ“… No date provided. Using Today: $THE_DATE"
          fi
          
          # 3. Clean up whitespace (just in case)
          THE_DATE=$(echo "$THE_DATE" | xargs)
          THE_RATE=$(echo "$THE_RATE" | xargs)

          # 4. Create the final line
          NEW_LINE="$THE_DATE,$THE_RATE"
          echo "âœï¸ Writing: $NEW_LINE"
          
          # 5. Append to file
          echo "$NEW_LINE" >> "CBSL rates.txt"
          
          # 6. Save to GitHub
          git config --global user.name "Telegram Bot"
          git config --global user.email "actions@github.com"
          git add "CBSL rates.txt"
          git commit -m "ðŸ“± Update: $NEW_LINE"
          git push
