name: Daily CBSL Rate Update

on:
  schedule:
    - cron: '0 4 * * *' # Runs at 9:30 AM Sri Lanka Time
  workflow_dispatch: # Allows manual trigger

permissions:
  contents: write

jobs:
  update-rates:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: pip install requests beautifulsoup4

      - name: Fetch and Process Rates
        run: |
          import requests
          from bs4 import BeautifulSoup
          from datetime import datetime
          import sys

          # 1. Setup Request
          url = "https://www.cbsl.gov.lk/en/rates-and-indicators/exchange-rates/daily-buy-and-sell-exchange-rates"
          # Use headers that look like a real Chrome browser
          headers = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
              'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
              'Accept-Language': 'en-US,en;q=0.5'
          }

          try:
              print(f"Connecting to {url}...")
              # verify=False prevents SSL errors common with some gov sites
              response = requests.get(url, headers=headers, timeout=30, verify=False) 
              print(f"Response Status: {response.status_code}")
              
              if response.status_code != 200:
                  print("‚ùå Failed to load page.")
                  sys.exit(1)

              soup = BeautifulSoup(response.content, 'html.parser')
              
              # 2. Search for the Rate
              jpy_rate = None
              tables = soup.find_all('table')
              
              print(f"Found {len(tables)} tables on the page.")

              for table in tables:
                  rows = table.find_all('tr')
                  for row in rows:
                      text = row.text.strip().lower()
                      
                      # DEBUG: Uncomment the next line to see all rows in logs if it still fails
                      # print(f"Checking row: {text[:50]}...") 

                      # Flexible Search: Look for 'japanese yen' OR 'jpy'
                      if "japanese yen" in text or "jpy" in text:
                          cols = row.find_all('td')
                          # Usually: [Name, Buying, Selling, ...]
                          # We need the 3rd column (Index 2) for Selling Rate
                          if len(cols) >= 3:
                              raw_rate = cols[2].text.strip()
                              if raw_rate:
                                  jpy_rate = raw_rate
                                  print(f"‚úÖ Found Rate! Row: '{text[:20]}...' -> Selling Rate: {jpy_rate}")
                                  break
                  if jpy_rate:
                      break

              # 3. Save or Fail
              if jpy_rate:
                  # Clean the rate (remove commas/spaces)
                  clean_rate = jpy_rate.replace(',', '').strip()
                  
                  # Validate it's a number
                  try:
                      float(clean_rate)
                  except ValueError:
                      print(f"‚ùå Error: Found value '{clean_rate}' is not a valid number.")
                      sys.exit(1)

                  today = datetime.now().strftime("%Y-%m-%d")
                  new_line = f"{today},{clean_rate}"
                  
                  filename = "CBSL rates.txt"
                  
                  # Check if we already have today's rate to avoid duplicates
                  try:
                      with open(filename, "r") as f:
                          last_line = f.readlines()[-1].strip()
                          if today in last_line:
                              print("‚ö†Ô∏è Rate for today already exists. Skipping update.")
                              sys.exit(0)
                  except FileNotFoundError:
                      pass # File doesn't exist yet, that's fine

                  # Append to file
                  with open(filename, "a") as f:
                      f.write(f"\n{new_line}")
                  print(f"‚úÖ Successfully appended: {new_line}")

              else:
                  print("‚ùå Error: Could not find 'Japanese Yen' or 'JPY' in any table.")
                  print("Dumping first 5 rows of the first table for debugging:")
                  if tables:
                      for i, r in enumerate(tables[0].find_all('tr')[:5]):
                          print(f"Row {i}: {r.text.strip()}")
                  sys.exit(1)

          except Exception as e:
              print(f"‚ùå Critical Error: {e}")
              sys.exit(1)

        shell: python

      - name: Commit and Push
        run: |
          git config --global user.name "Auto-Update Bot"
          git config --global user.email "actions@github.com"
          git add "CBSL rates.txt"
          git diff --quiet && git diff --staged --quiet || (git commit -m "üìà Auto-update CBSL Selling Rate" && git push)
