(function(){'use strict';const EXCISE_RATES={petrol:[{max:1e3,rate:cc=>Math.max(2450*cc,1992e3),min:601},{max:1300,rate:3850},{max:1500,rate:4450},{max:1600,rate:5150},{max:1800,rate:6400},{max:2e3,rate:7700},{max:2500,rate:8450},{max:2750,rate:9650},{max:3e3,rate:10850},{max:4e3,rate:12050},{max:1/0,rate:13300}],'petrol-hybrid':[{'max':1e3,'rate':()=>18109e2,'min':601},{max:1300,rate:2750},{max:1500,rate:3450},{max:1600,rate:4800},{max:1800,rate:6300},{max:2e3,rate:6900},{max:2500,rate:7250},{max:2750,rate:8450},{max:3e3,rate:9650},{max:4e3,rate:10850},{max:1/0,rate:12050}],'petrol-plugin':[{'max':1e3,'rate':()=>18109e2,'min':601},{max:1300,rate:2750},{max:1500,rate:3450},{max:1600,rate:4800},{max:1800,rate:6250},{max:2e3,rate:6900},{max:2500,rate:7250},{max:2750,rate:8450},{max:3e3,rate:9650},{max:4e3,rate:10850},{max:1/0,rate:12050}],diesel:[{max:1500,rate:5500,min:901},{max:1600,rate:6950},{max:1800,rate:8300},{max:2e3,rate:9650},{max:2500,rate:9650},{max:2750,rate:10850},{max:3e3,rate:12050},{max:4e3,rate:13300},{max:1/0,rate:14500}],'diesel-hybrid':[{'max':1500,rate:4150,min:901},{max:1600,rate:5500},{max:1800,rate:6900},{max:2e3,rate:8350},{max:2500,rate:8450},{max:2750,rate:9650},{max:3e3,rate:10850},{max:4e3,rate:12050},{max:1/0,rate:13300}],'diesel-plugin':[{'max':1500,rate:4150,min:901},{max:1600,rate:5500},{max:1800,rate:6900},{max:2e3,rate:8300},{max:2500,rate:8450},{max:2750,rate:9650},{max:3e3,rate:10850},{max:4e3,rate:12050},{max:1/0,rate:13300}],'e-smart-petrol':[{max:50,rate:age=>age===1?30770:43440},{max:100,rate:age=>age===1?40970:43440},{max:200,rate:age=>age===1?41630:63420},{max:1/0,rate:age=>age===1?111090:139440}],'e-smart-diesel':[{max:50,rate:age=>age===1?36920:52130},{max:100,rate:age=>age===1?49160:52130},{max:200,rate:age=>age===1?49960:76100},{max:1/0,rate:age=>age===1?133310:167330}],electric:[{max:50,rate:age=>age===1?18100:36200},{max:100,rate:age=>age===1?24100:36200},{max:200,rate:age=>age===1?36200:60400},{max:1/0,rate:age=>age===1?96600:132800}]};const LUXURY_THRESHOLDS={petrol:5e6,diesel:5e6,'petrol-hybrid':5.5e6,'petrol-plugin':5.5e6,'diesel-hybrid':5.5e6,'diesel-plugin':5.5e6,'e-smart-petrol':6e6,'e-smart-diesel':6e6,electric:6e6};const LUXURY_RATES={petrol:1.2,diesel:1.2,'petrol-hybrid':.8,'petrol-plugin':.8,'diesel-hybrid':.8,'diesel-plugin':.8,'e-smart-petrol':.6,'e-smart-diesel':.6,electric:.6};function findRate(type,capacity,age){const rates=EXCISE_RATES[type]||[];const validRate=rates.find(r=>capacity>r.min&&capacity<=r.max);if(!validRate)return 0;const rateFn=typeof validRate.rate==='function'?validRate.rate(capacity,age):validRate.rate;return rateFn||0}function calculateExcise(type,capacity,age){if(['petrol','petrol-hybrid','petrol-plugin'].includes(type)&&capacity<=600)return{valid:false,error:"Enter valid engine capacity (min 601cc for Petrol/Hybrid)"};if(['diesel','diesel-hybrid','diesel-plugin'].includes(type)&&capacity<=900)return{valid:false,error:"Enter valid engine capacity (min 901cc for Diesel)"};const rate=findRate(type,capacity,age);if(rate===0)return{valid:false,error:"Invalid capacity range"};const isKw=['e-smart-petrol','e-smart-diesel','electric'].includes(type);const excise=isKw?rate*capacity:rate*capacity;return{valid:true,excise,rate,unit:isKw?'kW':'cc'}}function formatCurrency(amount){return new Intl.NumberFormat('en-LK',{style:'currency',currency:'LKR',minimumFractionDigits:0}).format(amount)}function getLuxuryTax(cifLkr,type){const threshold=LUXURY_THRESHOLDS[type]||5e6;if(cifLkr<=threshold)return 0;const excess=cifLkr-threshold;return excess*LUXURY_RATES[type]||0}window.TaxCalculator={init:function(){const form=document.getElementById('taxForm');const vehicleType=document.getElementById('vehicleType');const capacityInput=document.getElementById('capacity');const capacityLabel=document.getElementById('capacityLabel');vehicleType.addEventListener('change',()=>{const type=vehicleType.value;const isKw=['e-smart-petrol','e-smart-diesel','electric'].includes(type);capacityLabel.textContent=isKw?'Enter kW capacity':'Enter CC capacity';capacityInput.placeholder=isKw?'Enter kW (1-300)':'Enter CC (601-4000)';});this.fetchExchangeRate();form.addEventListener('submit',e=>this.handleSubmit(e))},fetchExchangeRate:function(){fetch('https://api.exchangerate.host/latest?base=JPY&symbols=LKR').then(r=>r.json()).then(data=>{if(data.success){const rate=data.rates.LKR;document.getElementById('exchangeRate').textContent=`1 JPY = ${rate.toFixed(4)} LKR (Live)`;localStorage.setItem('jpy_lkr_rate',rate)}}).catch(()=>{const fallback=28.5;document.getElementById('exchangeRate').textContent=`1 JPY = ${fallback.toFixed(4)} LKR (Fallback)`;localStorage.setItem('jpy_lkr_rate',fallback)})},handleSubmit:function(e){e.preventDefault();const btn=document.getElementById('calculateBtn');const loading=document.getElementById('loading');const resultsSection=document.getElementById('resultsSection');const errorEl=document.getElementById('errorMessage');errorEl.classList.remove('show');btn.disabled=true;btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Calculating...';loading.classList.add('show');setTimeout(()=>{try{this.calculateTaxes()}catch(err){showError('Calculation error. Please try again.')}finally{btn.disabled=false;btn.innerHTML='<i class="fas fa-calculator"></i> Calculate Taxes';loading.classList.remove('show')}},1500)},calculateTaxes:function(){const formData=new FormData(document.getElementById('taxForm'));const type=formData.get('vehicleType');const capacity=parseFloat(formData.get('capacity'));const age=parseInt(formData.get('vehicleAge'));const cifJpy=parseFloat(formData.get('cifJpy'));const dealerFee=parseFloat(formData.get('dealerFee'))||0;const clearingFee=parseFloat(formData.get('clearingFee'))||0;if(!type||!capacity||!cifJpy){showError('Please fill all required fields');return}const exchangeRate=parseFloat(localStorage.getItem('jpy_lkr_rate'))||28.5;const cifLkr=cifJpy*exchangeRate;const exciseResult=calculateExcise(type,capacity,age);if(!exciseResult.valid){showError(exciseResult.error);return}const cid=cifLkr*.2;const surcharge=cid*.5;const luxuryTax=getLuxuryTax(cifLkr,type);const vel=15e3;const vatBase=cifLkr*1.1+cid+surcharge+exciseResult.excise+luxuryTax+vel;const vat=vatBase*.18;const totalTax=cid+surcharge+exciseResult.excise+luxuryTax+vel+vat;const totalCost=cifLkr+totalTax+dealerFee+clearingFee;const results=[{label:'CIF Value',amount:cifLkr,class:''},{label:'CID (20%)',amount:cid,class:''},{label:'Surcharge (50%)',amount:surcharge,class:''},{label:'Excise Duty',amount:exciseResult.excise,class:'highlight'},{label:'Luxury Tax',amount:luxuryTax,class:luxuryTax>0?'highlight':''},{label:'VEL',amount:vel,class:''},{label:'VAT (18%)',amount:vat,class:'highlight'},{label:'<strong>Total Taxes</strong>',amount:totalTax,class:'total-final'},{label:'<strong>Dealer + Clearing</strong>',amount:dealerFee+clearingFee,class:''},{label:'<strong>TOTAL LAND COST</strong>',amount:totalCost,class:'total-final'}];this.renderResults(results,exciseResult,totalCost,cifJpy);this.renderCharts(results);this.updateWhatsAppBtn(totalCost,cifJpy);resultsSection.style.display='block';window.scrollTo({top:resultsSection.offsetTop-100,behavior:'smooth'})},renderResults:function(results,exciseInfo,totalCost,cifJpy){const grid=document.getElementById('resultsGrid');grid.innerHTML='';results.forEach(({label,amount,className})=>{const div=document.createElement('div');div.className=`result-card ${className}`;div.innerHTML=`<h3><i class="fas fa-coins"></i> ${label}</h3><div class="result-amount">${formatCurrency(amount)}</div>`;grid.appendChild(div)})},renderCharts:function(results){const ctx1=document.getElementById('taxDistributionChart');const ctx2=document.getElementById('totalCostChart');if(window.taxDistChart){window.taxDistChart.destroy()}if(window.totalCostChart){window.totalCostChart.destroy()}const taxComponents=results.filter(r=>r.amount>0&&r.label!=='CIF Value'&&r.label!=='TOTAL LAND COST'&&r.label!=='Dealer + Clearing');const taxLabels=taxComponents.map(r=>r.label.replace(/\(.*?\)/,'').replace(/<[^>]*>/g,''));const taxData=taxComponents.map(r=>r.amount);window.taxDistChart=new Chart(ctx1,{type:'doughnut',data:{labels:taxLabels,datasets:[{data:taxData,backgroundColor:['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#06b6d4','#f97316'],borderWidth:0}]},options:{responsive:true,plugins:{legend:{position:'bottom',labels:{padding:20,font:{size:11}}}}}});const totalBreakdown=[{label:'CIF Value',value:results.find(r=>r.label==='CIF Value').amount,color:'#3b82f6'},{label:'Total Taxes',value:results.find(r=>r.label.includes('Total Taxes')).amount,color:'#10b981'},{label:'Fees',value:results.find(r=>r.label.includes('Dealer')).amount,color:'#f59e0b'}];window.totalCostChart=new Chart(ctx2,{type:'pie',data:{labels:totalBreakdown.map(b=>b.label),datasets:[{data:totalBreakdown.map(b=>b.value),backgroundColor:totalBreakdown.map(b=>b.color),borderWidth:0}]},options:{responsive:true,plugins:{legend:{position:'bottom',labels:{padding:20,font:{size:11}}}}}})},updateWhatsAppBtn:function(totalCost,cifJpy){const btn=document.getElementById('whatsappBtn');const totalStr=formatCurrency(totalCost).replace(/[^\d]/g,'');const cifStr=cifJpy.toLocaleString();btn.href=`https://wa.me/94777777777?text=ðŸš—%20Vehicle%20Import%20Quote%0A%0ACIF:%20${cifStr}%20JPY%0ATotal%20Land%20Cost:%20${totalStr}%0A%0APlease%20send%20vehicle%20details!`},downloadPDF:function(){const {jsPDF}=window.jspdf;const doc=new jsPDF();doc.setFontSize(20);doc.text('Sri Lanka Vehicle Import Tax Report',20,20);doc.setFontSize(12);doc.text('Amarasinghe Prime Enterprises (Pvt) Ltd | PV 00342707',20,35);const results=document.querySelectorAll('.result-card');let y=60;results.forEach((card,i)=>{if(i<8){const label=card.querySelector('h3').textContent;const amount=card.querySelector('.result-amount').textContent;y+=10;doc.text(label+': '+amount,20,y);y+=7}});doc.autoTable({startY:y+10,head:[{content:'Tax Summary',colSpan:2,styles:{fillColor:[30,64,175],textColor:255,fontStyle:'bold'}}],body:[['Total Land Cost',formatCurrency(parseFloat(results[results.length-1].querySelector('.result-amount').textContent.replace(/[^\d]/g,'')))]],theme:'grid',styles:{fontSize:10},headStyles:{fillColor:[16,185,129]}});doc.save('vehicle-tax-report.pdf')},copyResults:function(){const results=document.querySelectorAll('.result-card');let text='ðŸš— VEHICLE TAX SUMMARY\n\n';results.forEach(card=>{const label=card.querySelector('h3').textContent;const amount=card.querySelector('.result-amount').textContent;text+=`${label}: ${amount}\n`});navigator.clipboard.writeText(text).then(()=>{alert('Results copied to clipboard! ðŸ“‹')})}};document.addEventListener('DOMContentLoaded',()=>TaxCalculator.init());window.TaxCalculator=TaxCalculator})()
