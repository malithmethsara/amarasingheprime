// /js/sl-tax-calc.js - Complete & Hidden Sri Lanka Vehicle Tax Calculator 2025
!function(){var e={petrol:[{min:601,max:1e3,calc:function(e){return Math.max(2450*e,1992e3)}},{max:1300,rate:3850},{max:1500,rate:4450},{max:1600,rate:5150},{max:1800,rate:6400},{max:2e3,rate:7700},{max:2500,rate:8450},{max:2750,rate:9650},{max:3e3,rate:10850},{max:4e3,rate:12050},{max:1/0,rate:13300}],petrol_hybrid:[{min:601,max:1e3,fixed:18109e2},{max:1300,rate:2750},{max:1500,rate:3450},{max:1600,rate:4800},{max:1800,rate:6300},{max:2e3,rate:6900},{max:2500,rate:7250},{max:2750,rate:8450},{max:3e3,rate:9650},{max:4e3,rate:10850},{max:1/0,rate:12050}],petrol_plugin:[{min:601,max:1e3,fixed:18109e2},{max:1300,rate:2750},{max:1500,rate:3450},{max:1600,rate:4800},{max:1800,rate:6250},{max:2e3,rate:6900},{max:2500,rate:7250},{max:2750,rate:8450},{max:3e3,rate:9650},{max:4e3,rate:10850},{max:1/0,rate:12050}],diesel:[{min:901,max:1500,rate:5500},{max:1600,rate:6950},{max:1800,rate:8300},{max:2e3,rate:9650},{max:2500,rate:9650},{max:2750,rate:10850},{max:3e3,rate:12050},{max:4e3,rate:13300},{max:1/0,rate:14500}],diesel_hybrid:[{min:901,max:1500,rate:4150},{max:1600,rate:5500},{max:1800,rate:6900},{max:2e3,rate:8350},{max:2500,rate:8450},{max:2750,rate:9650},{max:3e3,rate:10850},{max:4e3,rate:12050},{max:1/0,rate:13300}],diesel_plugin:[{min:901,max:1500,rate:4150},{max:1600,rate:5500},{max:1800,rate:6900},{max:2e3,rate:8300},{max:2500,rate:8450},{max:2750,rate:9650},{max:3e3,rate:10850},{max:4e3,rate:12050},{max:1/0,rate:13300}],esmart_petrol:[{max:50,rate:function(e){return"1"===e?30770:43440}},{max:100,rate:function(e){return"1"===e?40970:43440}},{max:200,rate:function(e){return"1"===e?41630:63420}},{max:1/0,rate:function(e){return"1"===e?111090:139440}}],esmart_diesel:[{max:50,rate:function(e){return"1"===e?36920:52130}},{max:100,rate:function(e){return"1"===e?49160:52130}},{max:200,rate:function(e){return"1"===e?49960:76100}},{max:1/0,rate:function(e){return"1"===e?133310:167330}}],electric:[{max:50,rate:function(e){return"1"===e?18100:36200}},{max:100,rate:function(e){return"1"===e?24100:36200}},{max:200,rate:function(e){return"1"===e?36200:60400}},{max:1/0,rate:function(e){return"1"===e?96600:132800}}]},t={petrol:5e6,diesel:5e6,petrol_hybrid:5.5e6,petrol_plugin:5.5e6,diesel_hybrid:5.5e6,diesel_plugin:5.5e6,electric:6e6,esmart_petrol:6e6,esmart_diesel:6e6},r={petrol:1,diesel:1.2,petrol_hybrid:.8,petrol_plugin:.8,diesel_hybrid:.8,diesel_plugin:.8,electric:.6,esmart_petrol:.6,esmart_diesel:.6};function a(e,a,n){var i=e[t[e]]||5e6,o=r[e]||1;return a>i?(a-i)*o:0}function n(e,t,r){var a=e.find((function(e){return t>e.min&&t<=e.max}));if(!a)return 0;if(a.fixed)return a.fixed;if(a.calc)return a.calc(t);var n= "function" ==typeof a.rate ? a.rate(r) : a.rate;return n*t}function i(e,a,n){var i=e.includes("petrol")&&!e.includes("plugin")?600:e.includes("diesel")?900:0;if(t<i)return{error:"Enter valid capacity (min "+i+(e.includes("electric")||e.includes("esmart")?" kW":" cc")+")"};var o=n(e,t,r);return o.error?o:{excise:o}}function o(e){return e.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:0})}function l(){var e=parseFloat(document.getElementById("cifJPY").value),t=parseFloat(document.getElementById("exchangeRate").value),r=document.getElementById("vehicleType").value,l=parseFloat(document.getElementById("capacity").value),s=document.getElementById("age").value,u=parseFloat(document.getElementById("dealerFee").value)||0,d=parseFloat(document.getElementById("clearingFee").value)||0;if(isNaN(e)||e<=0)return c("cifJPY","Valid CIF value required");if(isNaN(t)||t<=0)return c("exchangeRate","Valid exchange rate required");if(!r)return c("vehicleType","Select vehicle type");if(isNaN(l)||l<=0)return c("capacity","Valid capacity required");if(!s)return c("age","Select vehicle age");var p=e*t,h=i(r,l,s);if(h.error)return c("capacity",h.error);var f=p*.2,m=f*.5,g=h.excise,b=a(r,p),v=15e3,y=1.1*p+f+m+g+b+v,x=.18*y,w=f+m+g+b+v+x,S=u+d,I=p+w+S;window.resultData={cifJPY:e,exchangeRate:t,cif:p,type:r,capacity:l,age:s,dealerFee:u,clearingFee:d,cid:f,surcharge:m,excise:g,luxuryTax:b,vel:v,vat:x,totalTax:w,otherCharges:S,totalCost:I},document.getElementById("result").innerHTML='<table><thead><tr><th>Item</th><th>Amount (LKR)</th></tr></thead><tbody><tr><td>CIF Value</td><td>'+o(p)+'</td></tr><tr><td>Customs Import Duty (CID)</td><td>'+o(f)+'</td></tr><tr><td>Surcharge on CID</td><td>'+o(m)+'</td></tr><tr><td>Excise Duty</td><td>'+o(g)+'</td></tr><tr><td>Luxury Tax</td><td>'+o(b)+'</td></tr><tr><td>Vehicle Entitlement Levy (VEL)</td><td>'+o(v)+'</td></tr><tr><td>Value Added Tax (VAT)</td><td>'+o(x)+'</td></tr></tbody><tfoot><tr><td>Total Tax</td><td>'+o(w)+'</td></tr><tr><td>Dealer Fee</td><td>'+o(u)+'</td></tr><tr><td>Clearing Agent Fee</td><td>'+o(d)+'</td></tr><tr><td>Total Import Cost</td><td>'+o(I)+'</td></tr></tfoot></table>';var T=document.getElementById("taxPieChart").getContext("2d"),C=document.getElementById("pieChart").getContext("2d");new Chart(T,{type:"pie",data:{labels:["CID","Surcharge","Excise Duty","Luxury Tax","VEL","VAT"],datasets:[{data:[f,m,g,b,v,x],backgroundColor:["#FF6384","#36A2EB","#FFCE56","#4BC0C0","#9966FF","#FF9F40"]}]},options:{responsive:!0}}),new Chart(C,{type:"pie",data:{labels:["CIF Value","Total Tax","Other Charges"],datasets:[{data:[p,w,S],backgroundColor:["#FF6384","#36A2EB","#FFCE56"]}]},options:{responsive:!0}}),document.getElementById("downloadBtn").style.display="flex"}function s(){document.getElementById("taxCalculatorForm").reset(),document.getElementById("result").innerHTML='<p class="result-placeholder">Add input data and click the Calculate Tax button to get results</p><p class="result-help">Need help importing your vehicle to Sri Lanka? <a href="https://wa.me/message/XSPMWKK4BGVAM1" target="_blank" rel="noopener">Contact us on WhatsApp</a> for expert assistance!</p>',document.getElementById("downloadBtn").style.display="none"}function c(e,t){var r=document.getElementById(e);r.focus();var a=r.nextElementSibling;a&&a.classList.contains("error-message")||(a=document.createElement("div"),a.className="error-message",r.after(a)),a.textContent=t}function u(){document.querySelectorAll(".error-message").forEach((function(e){e.remove()}))}function d(){if(!window.resultData)return;var e=new jsPDF;e.autoTable({html:"#result table"}),e.save("tax_calculation.pdf")}document.addEventListener("DOMContentLoaded",(function(){document.getElementById("timeDateTime").textContent=new Date.toLocaleString(),fetch("https://api.exchangerate.host/latest?base=JPY&symbols=LKR").then((function(e){return e.json()})).then((function(e){var t=e.rates.LKR;document.getElementById("exchangeRate").value=t.toFixed(4),document.getElementById("cbslRate").textContent="Current JPY/LKR Rate: "+t.toFixed(4)+" (Source: exchangerate.host)"})).catch((function(){document.getElementById("cbslRate").textContent="Failed to fetch exchange rate. Please enter manually."}));document.getElementById("vehicleType").addEventListener("change",(function(){var e=this.value;document.getElementById("capacityLabel").textContent=e.includes("electric")||e.includes("esmart")?"Motor Capacity (kW):":"Engine Capacity (CC):"})),document.querySelectorAll(".faq-item h3").forEach((function(e){e.addEventListener("click",(function(){this.parentElement.classList.toggle("active")}))})),document.getElementById("calculateBtn").addEventListener("click",l),document.getElementById("resetBtn").addEventListener("click",s),document.getElementById("downloadBtn").addEventListener("click",d)}))}();
