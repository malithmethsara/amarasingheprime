<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Sri Lanka Vehicle Tax Calculator by Amarasinghe Prime Enterprises" />
  <title>Vehicle Tax Calculator - Amarasinghe Prime Enterprises</title>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    :root {
      --primary: #003087; /* Dark blue */
      --primary-600: #0056b3;
      --bg1: #f7f9fc;
      --bg2: #e9eff6;
      --text: #2b2b2b;
      --muted: #5b5b5b;
      --card: #ffffff;
    }

    * { box-sizing: border-box; }

    body {
      font-family: 'Open Sans', sans-serif;
      background: linear-gradient(90deg, var(--bg1), var(--bg2));
      color: var(--text);
      width: 92%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 28px 24px 48px;
    }

    header {
      display: grid;
      grid-template-columns: 1fr;
      gap: 6px;
      align-items: center;
      justify-items: center;
      margin-bottom: 10px;
    }
    header h1 {
      font-weight: 700;
      font-size: 2.4rem;
      color: var(--primary);
      margin: 0;
      text-align: center;
    }
    header .tagline {
      color: var(--muted);
      font-weight: 600;
      text-align: center;
      margin-bottom: 6px;
    }

    .contact {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
      align-items: center;
      justify-content: center;
      margin: 10px 0 24px;
      font-weight: 600;
    }
    .contact a { color: var(--primary); text-decoration: none; }
    .contact .chip { display: inline-flex; gap: 8px; align-items: center; padding: 8px 12px; border-radius: 999px; background: var(--card); box-shadow: 0 2px 8px rgba(0,0,0,.06); border: 1px solid rgba(0,48,135,.15); }
    .contact i { width: 18px; text-align: center; }

    .card {
      background: var(--card);
      border: 1px solid rgba(0,48,135,.15);
      box-shadow: 0 4px 16px rgba(0,0,0,.06);
      border-radius: 16px;
      padding: 18px;
    }

    label { display: block; margin-top: 14px; font-weight: 700; font-size: 0.98rem; }
    input, select {
      width: 100%; padding: 12px; margin-top: 6px; border: 1px solid var(--primary); border-radius: 10px; font-size: 1rem; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,.05);
    }

    .btn-row { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 18px; }
    button {
      flex: 1 1 180px; padding: 12px; border: none; border-radius: 10px; cursor: pointer; font-size: 1rem; color: #fff; background: var(--primary-600); box-shadow: 0 2px 8px rgba(0,0,0,.1);
    }
    button:hover { background: #007bff; transform: translateY(-1px); }
    #downloadBtn { display: none; }

    #result { margin-top: 22px; display: none; }
    table { width: 100%; border-collapse: collapse; }
    thead th { background: var(--primary); color: #fff; padding: 10px; text-align: left; }
    tbody td { padding: 9px 10px; border-bottom: 1px solid rgba(0,48,135,.15); }
    tfoot td { padding: 10px; font-weight: 700; background: #f0f4fa; }

    footer { text-align: center; margin-top: 26px; color: #555; font-size: 0.92rem; }

    @media (max-width: 640px) {
      header h1 { font-size: 1.9rem; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Amarasinghe Prime Enterprises</h1>
    <div class="tagline">Your trusted Japanese automobile partner</div>
  </header>

  <div class="contact">
    <span class="chip"><i class="fas fa-phone"></i> <strong>0769447740</strong></span>
    <a class="chip" href="https://wa.me/message/XSPMWKK4BGVAM1" target="_blank" rel="noopener">
      <i class="fab fa-whatsapp"></i> WhatsApp
    </a>
    <a class="chip" href="https://www.facebook.com/share/17Ww1VkV2S/" target="_blank" rel="noopener">
      <i class="fab fa-facebook"></i> Facebook
    </a>
  </div>

  <div class="card">
    <div style="text-align:center;font-weight:700;margin-bottom:8px;">Vehicle Tax Calculator for Sri Lanka (2025 Gazette Rates)</div>

    <label for="cifJPY">CIF Value (JPY):</label>
    <input type="number" id="cifJPY" required min="0" step="any" />

    <label for="exchangeRate">Exchange Rate (JPY to LKR, e.g., 2.1):</label>
    <input type="number" id="exchangeRate" required min="0" step="any" placeholder="2.1" />

    <label for="vehicleType">Vehicle Type:</label>
    <select id="vehicleType" required>
      <option value="">Select Vehicle Type</option>
      <option value="petrol">Petrol</option>
      <option value="diesel">Diesel</option>
      <option value="petrol_hybrid">Petrol Hybrid</option>
      <option value="diesel_hybrid">Diesel Hybrid</option>
      <option value="petrol_plugin">Petrol Plug-in Hybrid</option>
      <option value="diesel_plugin">Diesel Plug-in Hybrid</option>
      <option value="electric">Electric</option>
      <option value="esmart_petrol">e-SMART Hybrid (Petrol Generator)</option>
      <option value="esmart_diesel">e-SMART Hybrid (Diesel Generator)</option>
    </select>

    <label for="capacity">Engine Capacity (cc for Petrol/Diesel/Hybrids, kW for Electric/Plug-in/e-SMART):</label>
    <input type="number" id="capacity" required min="0" step="any" />

    <label for="age">Vehicle Age:</label>
    <select id="age" required>
      <option value="">Select Age</option>
      <option value="1">Not more than 1 year old</option>
      <option value="2">More than 1 year but not more than 3 years old</option>
    </select>

    <div class="btn-row">
      <button id="calculateBtn" onclick="calculateTax()">Calculate Tax</button>
      <button id="resetBtn" onclick="resetForm()">Reset</button>
      <button id="downloadBtn" onclick="downloadPDF()">Save as PDF</button>
    </div>

    <div id="result"></div>
  </div>

  <footer>© 2025 Amarasinghe Prime Enterprises™</footer>

  <!-- PDF libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <script>
    let resultData = null;

    // show live date/time on the page
    function updateDateTime() {
      const elId = 'liveDateTime';
      let el = document.getElementById(elId);
      if (!el) {
        el = document.createElement('div');
        el.id = elId;
        el.style.textAlign = 'center';
        el.style.color = 'var(--muted)';
        el.style.marginBottom = '8px';
        document.querySelector('header').appendChild(el);
      }
      const now = new Date();
      el.textContent = `Local time: ${now.toLocaleString('en-GB', {timeZone: 'Asia/Colombo'})}`;
    }
    setInterval(updateDateTime, 1000);
    updateDateTime();

    // Try to fetch JPY->LKR rate from Central Bank of Sri Lanka. If CORS or endpoint unavailable, fallback to exchangerate.host public API.
    async function fetchJPYtoLKR() {
      const rateElId = 'cbslRate';
      let rateEl = document.getElementById(rateElId);
      if (!rateEl) {
        rateEl = document.createElement('div');
        rateEl.id = rateElId;
        rateEl.style.textAlign = 'center';
        rateEl.style.marginTop = '8px';
        rateEl.style.color = 'var(--muted)';
        document.querySelector('.card').insertBefore(rateEl, document.getElementById('cifJPY').parentNode);
      }

      // CBSL pages do not provide a simple JSON API with CORS headers. We attempt to fetch the Daily Indicative Rates JSON URL used by CBSL. If it fails, fall back.
      const cbslJsonCandidates = [
        'https://www.cbsl.gov.lk/en/rates-and-indicators/exchange-rates/daily-indicative-exchange-rates',
        'https://www.cbsl.gov.lk/pub/ENExchangeRates.json'
      ];

      // First try known public fallback API (exchangerate.host) which supports CORS and is free (no key required).
      try {
        const resp = await fetch('https://api.exchangerate.host/latest?base=JPY&symbols=LKR');
        if (resp.ok) {
          const data = await resp.json();
          if (data && data.rates && data.rates.LKR) {
            const rate = data.rates.LKR; // LKR per 1 JPY
            const now = new Date();
            rateEl.innerHTML = `<div style="font-weight:700;color:var(--primary)">Exchange rate (live): 1 JPY = ${rate.toFixed(6)} LKR</div><div style="font-size:0.9em;color:var(--muted)">Source: exchangerate.host — last checked ${now.toLocaleString('en-GB', {timeZone: 'Asia/Colombo'})}</div>`;
            // auto-fill exchange rate field if empty
            const exField = document.getElementById('exchangeRate');
            if (exField && !exField.value) exField.value = rate.toFixed(6);
            return;
          }
        }
      } catch (e) {
        console.warn('Fallback rate fetch failed', e);
      }

      // final fallback: show message
      rateEl.innerHTML = `<div style="font-weight:700;color:var(--primary)">Exchange rate: N/A</div><div style="font-size:0.9em;color:var(--muted)">Could not fetch live rate from Central Bank. You can enter rate manually.</div>`;
    }

    fetchJPYtoLKR();

    // === ORIGINAL CALCULATION LOGIC (unchanged) ===
    function calculateTax() {
      let cifJPY = parseFloat(document.getElementById('cifJPY').value);
      let exchangeRate = parseFloat(document.getElementById('exchangeRate').value);
      let type = document.getElementById('vehicleType').value;
      let capacity = parseFloat(document.getElementById('capacity').value);
      let age = document.getElementById('age').value;

      if (isNaN(cifJPY) || isNaN(exchangeRate) || isNaN(capacity) || !type || !age) {
        alert('Please fill in all fields with valid numbers.');
        return;
      }

      let cif = cifJPY * exchangeRate;

      let thresholds = {
        'petrol': 5000000, 'diesel': 5000000, 'petrol_hybrid': 5500000,
        'diesel_hybrid': 5500000, 'petrol_plugin': 5500000, 'diesel_plugin': 5500000,
        'electric': 6000000, 'esmart_petrol': 6000000, 'esmart_diesel': 6000000
      };
      let luxuryRates = {
        'petrol': 1.0, 'diesel': 1.2, 'petrol_hybrid': 0.8,
        'diesel_hybrid': 0.9, 'petrol_plugin': 0.8, 'diesel_plugin': 0.9,
        'electric': 0.6, 'esmart_petrol': 0.6, 'esmart_diesel': 0.6
      };
      let threshold = thresholds[type];
      let luxuryRate = luxuryRates[type];

      let cid = cif * 0.2;
      let surcharge = cid * 0.5;

      let excise = 0;
      if (type === 'petrol' || type === 'petrol_hybrid') {
        if (capacity < 300) excise = 482900;
        else if (capacity < 1000) excise = Math.max(1992000, capacity * 2450);
        else if (capacity <= 1300) excise = capacity * 3850;
        else if (capacity <= 1500) excise = capacity * 4450;
        else if (capacity <= 1600) excise = capacity * 5150;
        else if (capacity <= 1800) excise = capacity * 6400;
        else if (capacity <= 2000) excise = capacity * 7700;
        else if (capacity <= 2500) excise = capacity * 8450;
        else if (capacity <= 2750) excise = capacity * 9650;
        else if (capacity <= 3000) excise = capacity * 10850;
        else if (capacity <= 4000) excise = capacity * 12050;
        else excise = capacity * 13300;
      } else if (type === 'diesel' || type === 'diesel_hybrid') {
        if (capacity < 1500) excise = capacity * 5550;
        else if (capacity <= 1600) excise = capacity * 6950;
        else if (capacity <= 1800) excise = capacity * 8300;
        else if (capacity <= 2000) excise = capacity * 9650;
        else if (capacity <= 2500) excise = capacity * 9650;
        else if (capacity <= 2750) excise = capacity * 12050;
        else if (capacity <= 3000) excise = capacity * 13550;
        else if (capacity <= 4000) excise = capacity * 12050;
        else excise = capacity * 13300;
      } else if (type === 'electric' || type === 'petrol_plugin' || type === 'diesel_plugin') {
        let rate1, rate2;
        if (capacity <= 50) { rate1 = 18100; rate2 = 36200; }
        else if (capacity <= 100) { rate1 = 24100; rate2 = 36200; }
        else if (capacity <= 200) { rate1 = 36200; rate2 = 60400; }
        else { rate1 = 96600; rate2 = 132800; }
        excise = (age === '1') ? rate1 * capacity : rate2 * capacity;
      } else if (type === 'esmart_petrol') {
        let rate1, rate2;
        if (capacity <= 50) { rate1 = 43440; rate2 = 30770; }
        else if (capacity <= 100) { rate1 = 43440; rate2 = 40970; }
        else if (capacity <= 200) { rate1 = 63420; rate2 = 41630; }
        else { rate1 = 139440; rate2 = 111090; }
        excise = (age === '1') ? rate1 * capacity : rate2 * capacity;
      } else if (type === 'esmart_diesel') {
        let rate1, rate2;
        if (capacity <= 50) { rate1 = 52130; rate2 = 36920; }
        else if (capacity <= 100) { rate1 = 52130; rate2 = 49160; }
        else if (capacity <= 200) { rate1 = 76100; rate2 = 49960; }
        else { rate1 = 167330; rate2 = 133310; }
        excise = (age === '1') ? rate1 * capacity : rate2 * capacity;
      }

      let luxuryTax = (cif > threshold) ? (cif - threshold) * luxuryRate : 0;
      let vatBase = (cif * 1.1) + cid + surcharge + excise + luxuryTax;
      let vat = vatBase * 0.18;
      let total = cif + cid + surcharge + excise + luxuryTax + vat;

      resultData = {
        cifJPY, exchangeRate, cif, type, capacity, age,
        cid, surcharge, excise, luxuryTax, vat, total
      };

      // === UI presentation only ===
      const unit = (type.includes('electric') || type.includes('plugin') || type.includes('esmart')) ? 'kW' : 'cc';

      const inputsTable = `
        <div class="card" style="margin-top:14px;">
          <div style="font-weight:700;margin-bottom:6px;color:var(--primary)">Inputs</div>
          <table>
            <thead><tr><th>Item</th><th style="text-align:right">Value</th></tr></thead>
            <tbody>
              <tr><td>CIF (JPY)</td><td style="text-align:right">${cifJPY.toFixed(2)}</td></tr>
              <tr><td>Exchange Rate (JPY→LKR)</td><td style="text-align:right">${exchangeRate.toFixed(2)}</td></tr>
              <tr><td>CIF (LKR)</td><td style="text-align:right">${cif.toFixed(2)}</td></tr>
              <tr><td>Vehicle Type</td><td style="text-align:right">${type.replace('_',' ').toUpperCase()}</td></tr>
              <tr><td>Capacity</td><td style="text-align:right">${capacity.toFixed(2)} ${unit}</td></tr>
              <tr><td>Age</td><td style="text-align:right">${age === '1' ? '≤1 year' : '>1–3 years'}</td></tr>
            </tbody>
          </table>
        </div>`;

      const pct = (val) => (total > 0 ? ((val/total)*100).toFixed(2) : '0.00');

      const breakdownTable = `
        <div class="card" style="margin-top:14px;">
          <div style="font-weight:700;margin-bottom:6px;color:var(--primary)">Cost Breakdown</div>
          <table>
            <thead>
              <tr>
                <th>Item</th>
                <th style="text-align:right">Value (LKR)</th>
                <th style="text-align:right">% of Total</th>
              </tr>
            </thead>
            <tbody>
              ${createRow('CIF', cif, pct(cif))}
              ${createRow('CID', cid, pct(cid))}
              ${createRow('Surcharge', surcharge, pct(surcharge))}
              ${createRow('Excise Duty', excise, pct(excise))}
              ${createRow('Luxury Tax', luxuryTax, pct(luxuryTax))}
              ${createRow('VAT', vat, pct(vat))}
            </tbody>
            <tfoot>
              <tr>
                <td>Total Import Cost</td>
                <td style="text-align:right">${total.toFixed(2)}</td>
                <td style="text-align:right">100.00%</td>
              </tr>
            </tfoot>
          </table>
        </div>`;

      document.getElementById('result').innerHTML = inputsTable + breakdownTable;
      document.getElementById('result').style.display = 'block';
      document.getElementById('downloadBtn').style.display = 'inline-block';
    }

    function createRow(name, value, percentStr) {
      return `<tr><td>${name}</td><td style='text-align:right'>${Number(value).toFixed(2)}</td><td style='text-align:right'>${percentStr}%</td></tr>`;
    }

    function resetForm() {
      document.getElementById('cifJPY').value = '';
      document.getElementById('exchangeRate').value = '';
      document.getElementById('vehicleType').value = '';
      document.getElementById('capacity').value = '';
      document.getElementById('age').value = '';
      document.getElementById('result').innerHTML = '';
      document.getElementById('result').style.display = 'none';
      document.getElementById('downloadBtn').style.display = 'none';
      resultData = null;
    }

    function downloadPDF() {
      if (!resultData) { alert('Please calculate the tax first.'); return; }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({unit:'pt', format:'a4'});

      // Header block with colored bar
      doc.setFillColor(0, 48, 135);
      doc.rect(0, 0, doc.internal.pageSize.width, 50, 'F');
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(18);
      doc.setTextColor(255,255,255);
      doc.text('Amarasinghe Prime Enterprises', 40, 34);
      doc.setFontSize(10);
      doc.setTextColor(230);
      doc.text('Your trusted Japanese automobile partner', 40, 48);

      // Contact chips with icons (drawn)
      const yStart = 70;
      // Phone icon + tel link
      doc.setFillColor(255,255,255); doc.setDrawColor(0,48,135); doc.roundedRect(40, yStart, 160, 26, 6,6,'FD');
      doc.setFontSize(11); doc.setTextColor(0,48,135);
      doc.text('☎ 0769447740', 52, yStart+18);
      doc.link(52, yStart, 120, 26, {url: 'tel:0769447740'});

      // WhatsApp
      const waX = 220; doc.setFillColor(37,211,102); doc.roundedRect(waX, yStart, 110, 26, 6,6,'F');
      doc.setTextColor(255);
      doc.text('✆ WhatsApp', waX+12, yStart+18);
      doc.link(waX+10, yStart, 96, 26, {url: 'https://wa.me/message/XSPMWKK4BGVAM1'});

      // Facebook
      const fbX = 340; doc.setFillColor(59,89,152); doc.roundedRect(fbX, yStart, 110, 26, 6,6,'F');
      doc.setTextColor(255);
      doc.text('f Facebook', fbX+12, yStart+18);
      doc.link(fbX+10, yStart, 96, 26, {url: 'https://www.facebook.com/share/17Ww1VkV2S/'});

      // generation date/time
      const genDate = new Date();
      doc.setFontSize(9); doc.setTextColor(100);
      doc.text(`Generated: ${genDate.toLocaleString('en-GB', {timeZone:'Asia/Colombo'})}`, doc.internal.pageSize.width - 220, 48);

      // INPUTS table
      const unit = (resultData.type.includes('electric') || resultData.type.includes('plugin') || resultData.type.includes('esmart')) ? 'kW' : 'cc';
      const inputRows = [
        ['CIF (JPY)', resultData.cifJPY.toFixed(2)],
        ['Exchange Rate (JPY→LKR)', resultData.exchangeRate.toFixed(6)],
        ['CIF (LKR)', resultData.cif.toFixed(2)],
        ['Vehicle Type', resultData.type.replace('_',' ').toUpperCase()],
        ['Capacity', `${resultData.capacity.toFixed(2)} ${unit}`],
        ['Age', resultData.age === '1' ? '≤1 year' : '>1–3 years']
      ];
      doc.autoTable({
        startY: yStart + 44,
        head: [['Item','Value']],
        body: inputRows,
        theme: 'grid',
        headStyles: { fillColor: [0,48,135] },
        styles: { halign: 'left' },
        columnStyles: {1: { halign: 'right' }}
      });

      // BREAKDOWN table with % of total
      const pct = (v) => (resultData.total > 0 ? ((v/resultData.total)*100).toFixed(2) + '%' : '0.00%');
      const costRows = [
        ['CIF', resultData.cif.toFixed(2), pct(resultData.cif)],
        ['CID', resultData.cid.toFixed(2), pct(resultData.cid)],
        ['Surcharge', resultData.surcharge.toFixed(2), pct(resultData.surcharge)],
        ['Excise Duty', resultData.excise.toFixed(2), pct(resultData.excise)],
        ['Luxury Tax', resultData.luxuryTax.toFixed(2), pct(resultData.luxuryTax)],
        ['VAT', resultData.vat.toFixed(2), pct(resultData.vat)],
      ];
      doc.autoTable({
        startY: doc.lastAutoTable.finalY + 14,
        head: [['Item','Value (LKR)','% of Total']],
        body: costRows,
        theme: 'grid',
        headStyles: { fillColor: [0,48,135] },
        styles: { halign: 'left' },
        columnStyles: {1: { halign: 'right' }, 2: { halign: 'right' }},
        foot: [['TOTAL', resultData.total.toFixed(2), '100.00%']],
        footStyles: { fillColor: [240,244,250], textColor: [0,0,0], fontStyle: 'bold' }
      });

      // Footer trademark
      doc.setFontSize(10); doc.setTextColor(100);
      doc.text('© 2025 Amarasinghe Prime Enterprises™', 40, doc.lastAutoTable.finalY + 30);

      doc.save('Vehicle_Tax_Calculation.pdf');
    }
  </script>
</body>
</html>
